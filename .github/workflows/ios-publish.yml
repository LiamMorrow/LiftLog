name: Release iOS

on:
  release:
    types: [created]

jobs:
  build:
    runs-on: macos-15

    env:
      # App Store Connect API auth (required for automatic signing)
      APPSTORE_CONNECT_API_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
      APPSTORE_CONNECT_API_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
      APPSTORE_CONNECT_API_KEY: ${{ secrets.APPSTORE_PRIVATE_KEY }}

      # App config
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN_REACT }}
      EXPO_PUBLIC_REVENUECAT_APPLE_API_KEY: ${{ secrets.EXPO_PUBLIC_REVENUECAT_APPLE_API_KEY }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 16.4.0

      - name: Set build number
        uses: mlilback/build-number@v1
        id: buildNumber
        with:
          base: 100
          run-id: ${{ github.run_number }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.x

      - name: Install JS dependencies
        working-directory: ./app
        run: npm ci

      - name: Build JS bundle (optional)
        working-directory: ./app
        run: npx expo export --platform ios || echo "Skipped"

      - name: Install CocoaPods
        working-directory: ./app
        run: |
          cd ios
          pod install

      - name: Generate exportOptions.plist (automatic signing)
        working-directory: ./app
        run: |
          cat > exportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${{ secrets.APPLE_TEAM_ID }}</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>destination</key>
            <string>export</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
          </dict>
          </plist>
          EOF

      - name: Archive iOS app (automatic signing)
        working-directory: ./app
        run: |
          mkdir -p ios/build
          xcodebuild archive \
            -workspace ios/LiftLog.xcworkspace \
            -scheme LiftLog \
            -sdk iphoneos \
            -configuration Release \
            -archivePath "${PWD}/ios/build/App.xcarchive" \
            -allowProvisioningUpdates \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            APP_DISPLAY_VERSION="${{ github.event.release.name }}" \
            APP_VERSION="${{ steps.buildNumber.outputs.build-number }}"

      - name: Export IPA
        working-directory: ./app
        run: |
          xcodebuild -exportArchive \
            -archivePath "${PWD}/ios/build/App.xcarchive" \
            -exportOptionsPlist exportOptions.plist \
            -exportPath "${PWD}/ios/build/export"

      - name: Upload to App Store Connect
        run: |
          xcrun altool \
            --upload-app \
            -f app/ios/build/export/LiftLog.ipa \
            -t ios \
            -u ${{ secrets.APPLE_UPLOAD_USER }} \
            -p '${{ secrets.APPLE_UPLOAD_PASS }}'
